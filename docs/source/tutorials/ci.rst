CI/CD
=====

Running the GitLab CI server
----------------------------

To run the gitlab CI server, you need to have `docker <https://www.docker.com>`_, `gitlab-runner <https://docs.gitlab.com/runner/>`_, and `Nvidia Container Toolkit <https://docs.nvidia.com/ai-enterprise/deployment/vmware/latest/docker.html>`_ installed on your machine. The ``/autox`` NAS should also be mounted for sharing checkpoints.

Once you have these installed, you can use the example config to run the gitlab CI server. The default location for the config is ``$HOME/.gitlab-runner/config.toml``.

.. code-block:: toml

    concurrent = 4
    check_interval = 0
    shutdown_timeout = 0

    [session_server]
      session_timeout = 1800

    [[runners]]                             # Runner for (parallel) GPU jobs
      name = "sj-k8s-gpu-005"
      limit = 1                             # Only 1 GPU job at a time
      url = "https://code.autox.ds"
      id = 468
      token = "<Token generated by GitLab runner registration>"
      token_obtained_at = 2025-07-07T20:01:30Z
      token_expires_at = 0001-01-01T00:00:00Z
      executor = "docker"
      [runners.cache]
        MaxUploadedArchiveSize = 0
        [runners.cache.s3]
        [runners.cache.gcs]
        [runners.cache.azure]
      [runners.docker]
        tls_verify = false
        image = "gitlab-runner:snapshot04"  # This image needs to be built with docker/gitlab-ci-image/Dockerfile
        ipc_mode="host"                     # Ignored when shm_size is set, but good to have
        pull_policy = "if-not-present"      # Prevents pulling the image every time
        privileged = false
        disable_entrypoint_overwrite = false
        oom_kill_disable = false
        disable_cache = false
        volumes = ["/cache", "/autox:/autox:rw"]  # mounts the /autox NAS to the containers
        entrypoint = ["/bin/bash", "-c"]
        shm_size = 34359738368              # 32 GiB. Deepspeed uses more than the default 64 MiB.
        network_mtu = 0
        gpus = "\"device=0,1\""             # Use GPU 0 and 1 for the multi-GPU runner

    [[runners]]                             # Runner for single-GPU jobs
      name = "sj-k8s-gpu-005"
      limit = 1
      url = "https://code.autox.ds"
      id = 471
      token = "<Token generated by GitLab runner registration>"
      token_obtained_at = 2025-07-29T20:18:22Z
      token_expires_at = 0001-01-01T00:00:00Z
      executor = "docker"
      [runners.cache]
        MaxUploadedArchiveSize = 0
        [runners.cache.s3]
        [runners.cache.gcs]
        [runners.cache.azure]
      [runners.docker]
        tls_verify = false
        image = "gitlab-runner:snapshot04"  # This image needs to be built with docker/gitlab-ci-image/Dockerfile
        pull_policy = "if-not-present"      # Prevents pulling the image every time
        privileged = false
        disable_entrypoint_overwrite = false
        oom_kill_disable = false
        gpus = "\"device=2\""               # Use GPU 2 for the single-GPU runner
        disable_cache = false
        volumes = ["/cache", "/autox:/autox:rw"]
        shm_size = 0
        network_mtu = 0

    [[runners]]                             # Runner for CPU jobs
      name = "sj-k8s-gpu-005"
      limit = 2                             # Up to 2 CPU jobs at a time
      url = "https://code.autox.ds"
      id = 470
      token = "<Another token generated by GitLab runner registration>"
      token_obtained_at = 2025-07-29T18:27:09Z
      token_expires_at = 0001-01-01T00:00:00Z
      executor = "docker"
      [runners.cache]
        MaxUploadedArchiveSize = 0
        [runners.cache.s3]
        [runners.cache.gcs]
        [runners.cache.azure]
      [runners.docker]
        tls_verify = false
        image = "gitlab-runner:snapshot04"  # This image needs to be built with docker/gitlab-ci-image/Dockerfile
        pull_policy = "if-not-present"      # Prevents pulling the image every time
        privileged = false
        disable_entrypoint_overwrite = false
        oom_kill_disable = false
        disable_cache = false
        volumes = ["/cache"]
        shm_size = 0
        network_mtu = 0

To verify the above config works, you can manually create a container using:

.. code-block:: bash

    # Test the multi-GPU runner setup
    docker container run -it --rm --gpus '"device=0,1"' --shm-size 34359738368 --ipc=host -v /autox:/autox:rw gitlab-runner:snapshot04
    # Test the single-GPU runner setup
    docker container run -it --rm --gpus '"device=2"' --shm-size 34359738368 --ipc=host -v /autox:/autox:rw gitlab-runner:snapshot04
    # Test the CPU-only runner setup
    docker container run -it --rm gitlab-runner:snapshot04

The gitlab runner can be started with:

.. code-block:: bash

    sudo gitlab-runner restart && gitlab-runner run

You can also use ``gitlab-runner status`` to check the status of the runner.

